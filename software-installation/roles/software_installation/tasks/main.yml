---
- name: Definir os_family seguro
  ansible.builtin.set_fact:
    os_family_safe: "{{ ansible_os_family | default('unknown') }}"

- name: Detectar host no disponible
  ansible.builtin.set_fact:
    host_unavailable: "{{ os_family_safe == 'unknown' }}"

- name: Marcar resultado como servidor no disponible
  ansible.builtin.set_fact:
    software_installation_asset:
      host: "{{ inventory_hostname }}"
      os_family: "{{ os_family_safe }}"
      checked_at: "{{ ansible_date_time.iso8601 | default('') }}"
      status: "unavailable"
      message: "Servidor no disponible"
      packages: []
  when: host_unavailable

- name: Terminar role en host no disponible
  ansible.builtin.meta: end_host
  when: host_unavailable

# =====================================================
# CARGAR CATALOGO LINUX UNA SOLA VEZ EN EL CONTROL (EE)
# =====================================================
- name: Linux | Cargar catalogo (vars) en control (run_once)
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/packages_linux.yml"
  delegate_to: localhost
  run_once: true
  register: linux_vars_loaded

- name: Linux | Publicar catalogo global (run_once)
  ansible.builtin.set_fact:
    global_linux_packages: "{{ linux_vars_loaded.ansible_facts.linux_packages | default([]) }}"
    global_repo_path: "{{ linux_vars_loaded.ansible_facts.repo_path | default('/software_repo') }}"
    global_dest_dir: "{{ linux_vars_loaded.ansible_facts.dest_dir | default('/home/' ~ (ansible_user | default('root'))) }}"
  delegate_to: localhost
  run_once: true

- name: Linux | Debug catalogo global (run_once)
  ansible.builtin.debug:
    msg:
      - "global_repo_path={{ hostvars['localhost'].global_repo_path | default('N/A') }}"
      - "global_dest_dir={{ hostvars['localhost'].global_dest_dir | default('N/A') }}"
      - "global_linux_packages_count={{ (hostvars['localhost'].global_linux_packages | default([])) | length }}"
  run_once: true
  when: os_family_safe != 'Windows'

# =========================
# Linux
# =========================
- name: Linux | Inicializar lista de resultados
  ansible.builtin.set_fact:
    linux_install_results: []
  when: os_family_safe != 'Windows'

- name: Linux | Instalar paquetes definidos
  ansible.builtin.include_tasks: linux_install_one.yml
  loop: "{{ hostvars['localhost'].global_linux_packages | default([]) }}"
  loop_control:
    loop_var: pkg
    label: "{{ pkg.name | default(pkg.file | default('package')) }}"
  when: os_family_safe != 'Windows'

- name: Linux | Construir asset final
  ansible.builtin.set_fact:
    software_installation_asset:
      host: "{{ inventory_hostname }}"
      os_family: "Linux"
      checked_at: "{{ ansible_date_time.iso8601 }}"
      status: "ok"
      message: ""
      packages: "{{ linux_install_results | default([]) }}"
  when: os_family_safe != 'Windows'

# =========================
# Windows
# =========================
- name: Windows | Cargar catalogo de paquetes (vars)
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/packages_windows.yml"
    name: cfg_win
  when: os_family_safe == 'Windows'

- name: Windows | Inicializar lista de resultados
  ansible.builtin.set_fact:
    win_install_results: []
  when: os_family_safe == 'Windows'

- name: Windows | Instalar paquetes definidos (extensible)
  ansible.builtin.include_tasks: windows_install_one.yml
  loop: "{{ cfg_win.windows_packages | default([]) }}"
  loop_control:
    loop_var: wpkg
    label: "{{ wpkg.name | default('windows_package') }}"
  when: os_family_safe == 'Windows'

- name: Windows | Construir asset final
  ansible.builtin.set_fact:
    software_installation_asset:
      host: "{{ inventory_hostname }}"
      os_family: "Windows"
      checked_at: "{{ ansible_date_time.iso8601 }}"
      status: "ok"
      message: ""
      packages: "{{ win_install_results | default([]) }}"
  when: os_family_safe == 'Windows'
