---
- name: Definir os_family seguro
  ansible.builtin.set_fact:
    os_family_safe: "{{ ansible_os_family | default('unknown') }}"

- name: Detectar host no disponible
  ansible.builtin.set_fact:
    host_unavailable: "{{ os_family_safe == 'unknown' }}"

- name: Marcar resultado como servidor no disponible
  ansible.builtin.set_fact:
    software_installation_asset:
      host: "{{ inventory_hostname }}"
      os_family: "{{ os_family_safe }}"
      checked_at: "{{ ansible_date_time.iso8601 | default('') }}"
      status: "unavailable"
      message: "Servidor no disponible"
      packages: []
  when: host_unavailable

- name: Terminar role en host no disponible
  ansible.builtin.meta: end_host
  when: host_unavailable

# =========================
# Linux
# =========================
- name: Linux | Cargar catalogo de paquetes (vars) (desde el control node)
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/packages_linux.yml"
    name: cfg_linux
  delegate_to: invd-ts-ansible
  run_once: true
  when: os_family_safe != 'Windows'

# ---- DEBUGS DIAGNOSTICO LINUX (START) ----
- name: Linux | Debug | role_path y archivo vars esperado
  ansible.builtin.debug:
    msg:
      - "role_path={{ role_path }}"
      - "vars_file={{ role_path }}/vars/packages_linux.yml"
  when: os_family_safe != 'Windows'

- name: Linux | Debug | cfg_linux definido?
  ansible.builtin.debug:
    msg: "cfg_linux is defined={{ cfg_linux is defined }}"
  when: os_family_safe != 'Windows'

- name: Linux | Debug | cfg_linux (contenido completo)
  ansible.builtin.debug:
    var: cfg_linux
  when: os_family_safe != 'Windows'

- name: Linux | Debug | keys dentro de cfg_linux
  ansible.builtin.debug:
    msg: "cfg_linux keys={{ cfg_linux.keys() | list if cfg_linux is defined else 'cfg_linux NO definido' }}"
  when: os_family_safe != 'Windows'

- name: Linux | Debug | cfg_linux.linux_packages definido?
  ansible.builtin.debug:
    msg: "cfg_linux.linux_packages is defined={{ (cfg_linux.linux_packages is defined) if (cfg_linux is defined) else false }}"
  when: os_family_safe != 'Windows'

- name: Linux | Debug | valor cfg_linux.linux_packages (si existe)
  ansible.builtin.debug:
    var: cfg_linux.linux_packages
  when:
    - os_family_safe != 'Windows'
    - cfg_linux is defined
    - cfg_linux.linux_packages is defined

- name: Linux | Debug | linux_packages plano existe?
  ansible.builtin.debug:
    msg:
      - "linux_packages (plano) is defined={{ linux_packages is defined }}"
      - "repo_path (plano) is defined={{ repo_path is defined }}"
      - "dest_dir (plano) is defined={{ dest_dir is defined }}"
  when: os_family_safe != 'Windows'

- name: Linux | Debug | valor linux_packages plano (si existe)
  ansible.builtin.debug:
    var: linux_packages
  when:
    - os_family_safe != 'Windows'
    - linux_packages is defined

# Opcional: intenta leer el archivo vars y mostrarlo (solo si existe en el host remoto).
# Si falla, NO rompe el play.
- name: Linux | Debug | mostrar contenido de packages_linux.yml (opcional)
  ansible.builtin.shell: "sed -n '1,200p' {{ role_path }}/vars/packages_linux.yml"
  register: dbg_varsfile
  changed_when: false
  failed_when: false
  when: os_family_safe != 'Windows'

- name: Linux | Debug | salida contenido packages_linux.yml (opcional)
  ansible.builtin.debug:
    var: dbg_varsfile.stdout
  when:
    - os_family_safe != 'Windows'
    - dbg_varsfile is defined
    - (dbg_varsfile.stdout | default('') | length) > 0
# ---- DEBUGS DIAGNOSTICO LINUX (END) ----

- name: Linux | Inicializar lista de resultados
  ansible.builtin.set_fact:
    linux_install_results: []
  when: os_family_safe != 'Windows'

# Importante: aquí dejo fallback por si cfg_linux no se pobló pero quedaron vars planas
- name: Linux | Instalar paquetes definidos (extensible)
  ansible.builtin.include_tasks: linux_install_one.yml
  loop: "{{ (cfg_linux.linux_packages | default(linux_packages | default([]))) }}"
  loop_control:
    loop_var: pkg
    label: "{{ pkg.name | default(pkg.file | default('package')) }}"
  when: os_family_safe != 'Windows'

- name: Linux | Construir asset final
  ansible.builtin.set_fact:
    software_installation_asset:
      host: "{{ inventory_hostname }}"
      os_family: "Linux"
      checked_at: "{{ ansible_date_time.iso8601 }}"
      status: "ok"
      message: ""
      packages: "{{ linux_install_results | default([]) }}"
  when: os_family_safe != 'Windows'

# =========================
# Windows
# =========================
- name: Windows | Cargar catalogo de paquetes (vars)
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/packages_windows.yml"
    name: cfg_win
  when: os_family_safe == 'Windows'

- name: Windows | Inicializar lista de resultados
  ansible.builtin.set_fact:
    win_install_results: []
  when: os_family_safe == 'Windows'

- name: Windows | Instalar paquetes definidos (extensible)
  ansible.builtin.include_tasks: windows_install_one.yml
  loop: "{{ cfg_win.windows_packages | default([]) }}"
  loop_control:
    loop_var: wpkg
    label: "{{ wpkg.name | default('windows_package') }}"
  when: os_family_safe == 'Windows'

- name: Windows | Construir asset final
  ansible.builtin.set_fact:
    software_installation_asset:
      host: "{{ inventory_hostname }}"
      os_family: "Windows"
      checked_at: "{{ ansible_date_time.iso8601 }}"
      status: "ok"
      message: ""
      packages: "{{ win_install_results | default([]) }}"
  when: os_family_safe == 'Windows'
