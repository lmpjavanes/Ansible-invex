---
# Requiere: pkg (item del loop) y linux_install_results definido.
# pkg puede contener:
#   name, file, repo_path, dest_dir, install_cmd, validate_cmd,
#   token, token_cmd, start_cmd, status_cmd,
#   metadata_cmd (opcional para extraer name/version/vendor/summary/description)
#
- name: Linux | Definir rutas del paquete
  ansible.builtin.set_fact:
    _repo_path: "{{ pkg.repo_path | default(cfg_linux.repo_path | default('/software_repo')) }}"
    _dest_dir: "{{ pkg.dest_dir | default(cfg_linux.dest_dir | default('/home/' ~ (ansible_user | default('root'))) ) }}"
    _pkg_file: "{{ pkg.file }}"
    _pkg_src: "{{ (pkg.repo_path | default(cfg_linux.repo_path | default('/software_repo'))) ~ '/' ~ pkg.file }}"
    _pkg_dest: "{{ (pkg.dest_dir | default(cfg_linux.dest_dir | default('/home/' ~ (ansible_user | default('root'))) )) ~ '/' ~ pkg.file }}"

- name: Linux | Asegurar directorio destino
  ansible.builtin.file:
    path: "{{ _dest_dir }}"
    state: directory
    mode: "0755"

- name: Linux | Copiar paquete desde el repo del controller hacia el host
  ansible.builtin.copy:
    src: "{{ _pkg_src }}"
    dest: "{{ _pkg_dest }}"
    mode: "0644"

- name: Linux | Ejecutar instalacion
  ansible.builtin.shell: "{{ pkg.install_cmd | default('rpm -ivh') }} {{ _pkg_dest }}"
  args:
    executable: /bin/bash
  register: linux_install_cmd
  changed_when: true
  failed_when: linux_install_cmd.rc != 0

- name: Linux | Validar instalacion
  ansible.builtin.shell: "{{ pkg.validate_cmd }}"
  args:
    executable: /bin/bash
  register: linux_validate_cmd
  changed_when: false
  failed_when: false

- name: Linux | Extraer metadata del RPM (name/version/vendor/summary/description)
  ansible.builtin.shell: >-
    {{ pkg.metadata_cmd | default("rpm -qip --queryformat '%{NAME}\n%{VERSION}-%{RELEASE}\n%{VENDOR}\n%{SUMMARY}\n%{DESCRIPTION}\n' " ~ _pkg_dest) }}
  args:
    executable: /bin/bash
  register: linux_rpm_meta
  changed_when: false
  failed_when: false

- name: Linux | Parsear metadata
  ansible.builtin.set_fact:
    _meta_lines: "{{ (linux_rpm_meta.stdout | default('') ).split('\n') }}"
    _meta_name: "{{ (_meta_lines | length > 0) | ternary((_meta_lines[0] | trim), (pkg.name | default(''))) }}"
    _meta_ver: "{{ (_meta_lines | length > 1) | ternary((_meta_lines[1] | trim), '') }}"
    _meta_vendor: "{{ (_meta_lines | length > 2) | ternary((_meta_lines[2] | trim), (pkg.vendor | default(''))) }}"
    _meta_summary: "{{ (_meta_lines | length > 3) | ternary((_meta_lines[3] | trim), (pkg.summary | default(''))) }}"
    _meta_desc: >-
      {{
        (_meta_lines | length > 4)
        | ternary((_meta_lines[4:] | join('\n') | trim), (pkg.description | default('')))
      }}

- name: Linux | Activacion por token (opcional)
  ansible.builtin.shell: "{{ (pkg.token_cmd | default('')) | regex_replace('Aqui_va_el_token', (pkg.token | default(''))) }}"
  args:
    executable: /bin/bash
  register: linux_token_cmd
  changed_when: true
  failed_when: false
  when:
    - (pkg.token_cmd | default('') | string | length) > 0

- name: Linux | Iniciar servicio (opcional)
  ansible.builtin.shell: "{{ pkg.start_cmd }}"
  args:
    executable: /bin/bash
  register: linux_start_cmd
  changed_when: true
  failed_when: false
  when:
    - (pkg.start_cmd | default('') | string | length) > 0

- name: Linux | Consultar estatus (opcional)
  ansible.builtin.shell: "{{ pkg.status_cmd }}"
  args:
    executable: /bin/bash
  register: linux_status_cmd
  changed_when: false
  failed_when: false
  when:
    - (pkg.status_cmd | default('') | string | length) > 0

- name: Linux | Determinar si servicio esta activo
  ansible.builtin.set_fact:
    _service_active: >-
      {%- set out = (linux_status_cmd.stdout | default('') | lower) -%}
      {{ 'yes' if ('running' in out or 'active' in out or 'started' in out) else 'unknown' }}
  when:
    - (pkg.status_cmd | default('') | string | length) > 0

- name: Linux | Registrar resultado por paquete
  ansible.builtin.set_fact:
    linux_install_results: "{{ linux_install_results + [ result_obj ] }}"
  vars:
    result_obj:
      host: "{{ inventory_hostname }}"
      checked_at: "{{ ansible_date_time.iso8601 }}"
      package: "{{ _meta_name | default(pkg.name | default(pkg.file)) }}"
      file: "{{ pkg.file }}"
      version_installed: "{{ _meta_ver | default('') }}"
      vendor: "{{ _meta_vendor | default('') }}"
      summary: "{{ _meta_summary | default('') }}"
      description: "{{ _meta_desc | default('') }}"
      repo_path: "{{ _repo_path }}"
      dest_path: "{{ _pkg_dest }}"
      command_install: "{{ (pkg.install_cmd | default('rpm -ivh')) ~ ' ' ~ _pkg_dest }}"
      command_validate: "{{ pkg.validate_cmd | default('') }}"
      command_token: "{{ (pkg.token_cmd | default('')) | regex_replace('Aqui_va_el_token', (pkg.token | default(''))) }}"
      command_start: "{{ pkg.start_cmd | default('') }}"
      command_status: "{{ pkg.status_cmd | default('') }}"
      validate_stdout: "{{ (linux_validate_cmd.stdout | default('')) | trim }}"
      token_stdout: "{{ (linux_token_cmd.stdout | default('')) | trim }}"
      status_stdout: "{{ (linux_status_cmd.stdout | default('')) | trim }}"
      service_active: "{{ _service_active | default('unknown') }}"
      install_rc: "{{ linux_install_cmd.rc | default('') }}"
      install_stdout: "{{ (linux_install_cmd.stdout | default('')) | trim }}"
      install_stderr: "{{ (linux_install_cmd.stderr | default('')) | trim }}"
