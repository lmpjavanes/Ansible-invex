---
- name: Linux | Definir host repositorio
  ansible.builtin.set_fact:
    _repo_host: "{{ pkg.repo_host | default('invd-ts-ansible') }}"

- name: Linux | Definir rutas (desde catalogo global en localhost)
  ansible.builtin.set_fact:
    _repo_path: "{{ pkg.repo_path | default(hostvars['localhost'].global_repo_path | default('/software_repo')) }}"
    _dest_dir: "{{ pkg.dest_dir | default(hostvars['localhost'].global_dest_dir | default('/home/' ~ (ansible_user | default('root')))) }}"
    _pkg_src: "{{ (pkg.repo_path | default(hostvars['localhost'].global_repo_path | default('/software_repo'))) ~ '/' ~ pkg.file }}"
    _pkg_dest: "{{ (pkg.dest_dir | default(hostvars['localhost'].global_dest_dir | default('/home/' ~ (ansible_user | default('root'))))) ~ '/' ~ pkg.file }}"

- name: Linux | Debug paquete
  ansible.builtin.debug:
    msg:
      - "repo_host={{ _repo_host }}"
      - "src={{ _pkg_src }}"
      - "dest={{ _pkg_dest }}"

- name: Linux | Asegurar directorio destino
  ansible.builtin.file:
    path: "{{ _dest_dir }}"
    state: directory
    mode: "0755"

# 1) Validar que el RPM exista en invd-ts-ansible
- name: Linux | Validar existencia del RPM en repo (en repo_host)
  ansible.builtin.stat:
    path: "{{ _pkg_src }}"
  register: repo_pkg_stat
  delegate_to: "{{ _repo_host }}"
  changed_when: false
  failed_when: false

- name: Linux | Flag RPM existe
  ansible.builtin.set_fact:
    _pkg_exists_in_repo: "{{ (repo_pkg_stat.stat.exists | default(false)) | bool }}"

# 2) Copiar RPM: scp desde invd-ts-ansible hacia el host destino
- name: Linux | Copiar RPM desde repo_host hacia host (scp)
  ansible.builtin.command: >
    scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
    "{{ _pkg_src }}"
    "{{ ansible_user | default('root') }}@{{ inventory_hostname }}:{{ _pkg_dest }}"
  delegate_to: "{{ _repo_host }}"
  register: scp_copy
  changed_when: true
  failed_when: false
  when: _pkg_exists_in_repo

# 3) Instalar
- name: Linux | Ejecutar instalacion
  ansible.builtin.shell: "{{ pkg.install_cmd | default('rpm -ivh') }} {{ _pkg_dest }}"
  args:
    executable: /bin/bash
  register: linux_install_cmd
  changed_when: true
  failed_when: false
  when: _pkg_exists_in_repo

# 4) Validar
- name: Linux | Validar instalacion
  ansible.builtin.shell: "{{ pkg.validate_cmd }}"
  args:
    executable: /bin/bash
  register: linux_validate_cmd
  changed_when: false
  failed_when: false
  when: _pkg_exists_in_repo

# 5) Metadata (del RPM local copiado)
- name: Linux | Extraer metadata del RPM
  ansible.builtin.shell: >-
    {{ pkg.metadata_cmd
       | default("rpm -qip --queryformat '%{NAME}\n%{VERSION}-%{RELEASE}\n%{VENDOR}\n%{SUMMARY}\n%{DESCRIPTION}\n' " ~ _pkg_dest)
    }}
  args:
    executable: /bin/bash
  register: linux_rpm_meta
  changed_when: false
  failed_when: false
  when: _pkg_exists_in_repo

- name: Linux | Parsear metadata
  ansible.builtin.set_fact:
    _meta_lines: "{{ (linux_rpm_meta.stdout | default('') ).split('\n') }}"
    _meta_name: "{{ (_meta_lines | length > 0) | ternary((_meta_lines[0] | trim), (pkg.name | default(''))) }}"
    _meta_ver: "{{ (_meta_lines | length > 1) | ternary((_meta_lines[1] | trim), '') }}"
    _meta_vendor: "{{ (_meta_lines | length > 2) | ternary((_meta_lines[2] | trim), (pkg.vendor | default(''))) }}"
    _meta_summary: "{{ (_meta_lines | length > 3) | ternary((_meta_lines[3] | trim), (pkg.summary | default(''))) }}"
    _meta_desc: >-
      {{
        (_meta_lines | length > 4)
        | ternary((_meta_lines[4:] | join('\n') | trim), (pkg.description | default('')))
      }}
  when: _pkg_exists_in_repo

# 6) Token/start/status (opcionales)
- name: Linux | Activacion por token (opcional)
  ansible.builtin.shell: "{{ (pkg.token_cmd | default('')) | regex_replace('Aqui_va_el_token', (pkg.token | default(''))) }}"
  args:
    executable: /bin/bash
  register: linux_token_cmd
  changed_when: true
  failed_when: false
  when:
    - _pkg_exists_in_repo
    - (pkg.token_cmd | default('') | string | length) > 0

- name: Linux | Iniciar servicio (opcional)
  ansible.builtin.shell: "{{ pkg.start_cmd }}"
  args:
    executable: /bin/bash
  register: linux_start_cmd
  changed_when: true
  failed_when: false
  when:
    - _pkg_exists_in_repo
    - (pkg.start_cmd | default('') | string | length) > 0

- name: Linux | Consultar estatus (opcional)
  ansible.builtin.shell: "{{ pkg.status_cmd }}"
  args:
    executable: /bin/bash
  register: linux_status_cmd
  changed_when: false
  failed_when: false
  when:
    - _pkg_exists_in_repo
    - (pkg.status_cmd | default('') | string | length) > 0

- name: Linux | Determinar si servicio esta activo
  ansible.builtin.set_fact:
    _service_active: >-
      {%- set out = (linux_status_cmd.stdout | default('') | lower) -%}
      {{ 'yes' if ('running' in out or 'active' in out or 'started' in out) else 'no' }}
  when:
    - _pkg_exists_in_repo
    - (pkg.status_cmd | default('') | string | length) > 0

# 7) Determinar status final (ok/failed)
- name: Linux | Determinar status final del paquete
  ansible.builtin.set_fact:
    _pkg_status: >-
      {{
        'failed'
        if (not _pkg_exists_in_repo)
           or ((scp_copy is defined) and ((scp_copy.rc | default(1)) != 0))
           or ((linux_install_cmd is defined) and ((linux_install_cmd.rc | default(1)) != 0))
        else 'ok'
      }}
    _pkg_message: >-
      {{
        'RPM no existe en repo: ' ~ _pkg_src
        if (not _pkg_exists_in_repo)
        else (
          'Fallo scp desde ' ~ _repo_host ~ ' a ' ~ inventory_hostname ~ ' (rc=' ~ (scp_copy.rc | string) ~ ')'
          if ((scp_copy is defined) and ((scp_copy.rc | default(1)) != 0))
          else (
            'Fallo instalacion (rc=' ~ (linux_install_cmd.rc | string) ~ ')'
            if ((linux_install_cmd is defined) and ((linux_install_cmd.rc | default(1)) != 0))
            else ''
          )
        )
      }}

# 8) Registrar resultado
- name: Linux | Registrar resultado por paquete
  ansible.builtin.set_fact:
    linux_install_results: "{{ linux_install_results + [ result_obj ] }}"
  vars:
    result_obj:
      host: "{{ inventory_hostname }}"
      checked_at: "{{ ansible_date_time.iso8601 }}"
      status: "{{ _pkg_status }}"
      message: "{{ _pkg_message }}"
      package: "{{ _meta_name | default(pkg.name | default(pkg.file)) }}"
      file: "{{ pkg.file }}"
      version_installed: "{{ _meta_ver | default('') }}"
      vendor: "{{ _meta_vendor | default('') }}"
      summary: "{{ _meta_summary | default('') }}"
      description: "{{ _meta_desc | default('') }}"
      repo_host: "{{ _repo_host }}"
      repo_path: "{{ _repo_path }}"
      dest_path: "{{ _pkg_dest }}"
      command_install: "{{ (pkg.install_cmd | default('rpm -ivh')) ~ ' ' ~ _pkg_dest }}"
      command_validate: "{{ pkg.validate_cmd | default('') }}"
      command_token: "{{ (pkg.token_cmd | default('')) | regex_replace('Aqui_va_el_token', (pkg.token | default(''))) }}"
      command_start: "{{ pkg.start_cmd | default('') }}"
      command_status: "{{ pkg.status_cmd | default('') }}"
      validate_stdout: "{{ (linux_validate_cmd.stdout | default('')) | trim }}"
      token_stdout: "{{ (linux_token_cmd.stdout | default('')) | trim }}"
      status_stdout: "{{ (linux_status_cmd.stdout | default('')) | trim }}"
      service_active: "{{ _service_active | default('n/a') }}"
      scp_rc: "{{ scp_copy.rc | default('') }}"
      scp_stdout: "{{ (scp_copy.stdout | default('')) | trim }}"
      scp_stderr: "{{ (scp_copy.stderr | default('')) | trim }}"
      install_rc: "{{ linux_install_cmd.rc | default('') }}"
      install_stdout: "{{ (linux_install_cmd.stdout | default('')) | trim }}"
      install_stderr: "{{ (linux_install_cmd.stderr | default('')) | trim }}"
