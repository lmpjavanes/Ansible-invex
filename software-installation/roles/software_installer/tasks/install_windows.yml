---
# roles/software_installer/tasks/install_windows.yml

- name: "Windows | Cargar configuración de paquetes"
  ansible.builtin.include_vars:
    file: software_packages_windows.yml
    name: win_config

- name: "Windows | Inicializar lista de resultados para este host"
  ansible.builtin.set_fact:
    host_installation_results: []

# ============================================
# DIAGNÓSTICO DE RUTA (VERSIÓN ULTRA SIMPLE)
# ============================================
- name: "Windows | DIAGNÓSTICO - Verificar ruta completa"
  ansible.windows.win_shell: |
    Write-Output "=== VERIFICANDO RUTA DE ARCHIVOS ==="
    Write-Output "Fecha: $(Get-Date)"
    Write-Output "Host: $env:COMPUTERNAME"
    Write-Output ""
    
    $ruta = "{{ win_config.windows_software_source }}"
    Write-Output "Ruta configurada: $ruta"
    Write-Output "Longitud de ruta: $($ruta.Length) caracteres"
    Write-Output ""
    
    # MÉTODO SIMPLE: Usar Test-Path directamente
    if (Test-Path $ruta) {
        Write-Output "✅ LA RUTA COMPLETA EXISTE"
        Write-Output ""
        Write-Output "Archivos encontrados:"
        Get-ChildItem $ruta | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
    } else {
        Write-Output "❌ LA RUTA COMPLETA NO EXISTE"
        Write-Output ""
        
        # Verificar si el servidor es accesible
        $servidor = $ruta -split '\\' | Select-Object -First 1
        $servidor = $servidor -replace '^\\\\', ''
        
        if ($servidor) {
            Write-Output "Verificando servidor: $servidor"
            if (Test-Connection -ComputerName $servidor -Count 1 -Quiet -ErrorAction SilentlyContinue) {
                Write-Output "✅ Servidor alcanzable"
            } else {
                Write-Output "❌ Servidor NO alcanzable"
            }
        }
        
        # Listar unidades de red mapeadas
        Write-Output ""
        Write-Output "Unidades de red disponibles:"
        Get-PSDrive -PSProvider FileSystem | Where-Object {$_.Root -like "\\*"} | 
            Select-Object Name, Root, Used, Free | Format-Table -AutoSize
    }
    
    Write-Output ""
    Write-Output "=== FIN DEL DIAGNÓSTICO ==="
  register: ruta_diagnostico

- name: "Windows | Mostrar diagnóstico de ruta"
  ansible.builtin.debug:
    msg: 
      - "DIAGNÓSTICO DE RUTA:"
      - "{{ ruta_diagnostico.stdout_lines }}"

- name: "Windows | Detener ejecución si la ruta no es accesible"
  ansible.builtin.fail:
    msg: "La ruta {{ win_config.windows_software_source }} no es accesible. Revisa el diagnóstico."
  when: "'LA RUTA COMPLETA NO EXISTE' in ruta_diagnostico.stdout"

- name: "Windows | Crear directorio de destino si no existe"
  ansible.windows.win_file:
    path: "{{ win_config.windows_dest_path }}"
    state: directory

- name: "Windows | Copiar archivos necesarios desde el NFS"
  ansible.windows.win_copy:
    src: "{{ win_config.windows_software_source }}\\{{ item }}"
    dest: "{{ win_config.windows_dest_path }}"
    remote_src: yes
  loop: "{{ win_config.windows_files_to_copy }}"
  register: copy_files_result

- name: "Windows | Determinar el script de instalación según el grupo"
  ansible.builtin.set_fact:
    install_script: >-
      {% if 'PROD' in group_names %}
      {{ win_config.windows_dest_path }}Instalar_Nagios_KIO.BAT
      {% elif 'DRP' in group_names %}
      {{ win_config.windows_dest_path }}Instalar_Nagios_TRIARA.BAT
      {% else %}
      ""
      {% endif %}

- name: "Windows | Ejecutar script de instalación (si se determinó uno)"
  ansible.windows.win_command: "{{ install_script }}"
  register: script_execution
  failed_when: false
  changed_when: false
  when: install_script != ""

- name: "Windows | Validar instalación (existencia de ncpa-latest.exe)"
  ansible.windows.win_stat:
    path: "C:\\Program Files\\Nagios\\NCPA\\ncpa-latest.exe"
  register: validation_stat

- name: "Windows | Obtener versión del ejecutable"
  ansible.windows.win_shell: "{{ win_config.ncpa_install.version_command }}"
  register: version_result
  failed_when: false
  changed_when: false
  when: validation_stat.stat.exists

- name: "Windows | Verificar estado del servicio NCPA"
  ansible.windows.win_shell: "{{ win_config.ncpa_install.status_command }}"
  register: service_status
  failed_when: false
  changed_when: false

- name: "Windows | Construir resultado de instalación"
  ansible.builtin.set_fact:
    host_installation_results: "{{ host_installation_results + [ pkg_result ] }}"
  vars:
    pkg_result:
      package_name: "{{ win_config.ncpa_install.package_name }}"
      description: "{{ win_config.ncpa_install.description }}"
      vendor: "{{ win_config.ncpa_install.vendor }}"
      status: "{{ 'success' if validation_stat.stat.exists else 'failed' }}"
      install_date: "{{ ansible_date_time.iso8601 }}"
      version_installed: "{{ version_result.stdout | default('') | trim }}"
      service_status: "{{ service_status.stdout | default('N/A') | trim }}"
      copy_output: "{{ copy_files_result }}"
      script_output: "{{ script_execution.stdout | default('') }}"

- name: "Windows | Determinar estado general del host"
  ansible.builtin.set_fact:
    overall_host_status: >-
      {% set failed_states = host_installation_results | selectattr('status', 'equalto', 'failed') | list %}
      {% if failed_states | length > 0 %}failed
      {% else %}success
      {% endif %}

- name: "Windows | Construir resultado final para el host"
  ansible.builtin.set_fact:
    software_installation_result:
      host: "{{ inventory_hostname }}"
      os_family: "Windows"
      overall_status: "{{ overall_host_status }}"
      packages: "{{ host_installation_results }}"
      message: "Procesado paquete NCPA."