---
# roles/software_installer/tasks/install_windows.yml

- name: "Windows | Cargar configuracion de paquetes"
  ansible.builtin.include_vars:
    file: software_packages_windows.yml
    name: win_config

- name: "Windows | Inicializar lista de resultados para este host"
  ansible.builtin.set_fact:
    host_installation_results: []

# ============================================
# PASO 1: VERIFICAR RUTA DE ORIGEN
# ============================================
- name: "Windows | Verificar que la ruta de origen existe"
  ansible.windows.win_shell: |
    $ruta = "{{ win_config.windows_software_source }}"
    if (Test-Path $ruta) {
        Write-Output "Ruta de origen accesible"
        exit 0
    } else {
        Write-Output "Ruta de origen NO accesible: $ruta"
        exit 1
    }
  register: ruta_check
  failed_when: ruta_check.rc != 0

# ============================================
# PASO 2: CREAR DIRECTORIO DESTINO
# ============================================
- name: "Windows | Crear directorio de destino"
  ansible.windows.win_file:
    path: "{{ win_config.windows_dest_path }}"
    state: directory

# ============================================
# PASO 3: COPIAR ARCHIVOS
# ============================================
- name: "Windows | Copiar archivos necesarios desde el NFS"
  ansible.windows.win_copy:
    src: "{{ win_config.windows_software_source }}\\{{ item }}"
    dest: "{{ win_config.windows_dest_path }}"
    remote_src: yes
  loop: "{{ win_config.windows_files_to_copy }}"
  register: copy_files_result

- name: "Windows | Verificar que los archivos se copiaron"
  ansible.windows.win_stat:
    path: "{{ win_config.windows_dest_path }}{{ item }}"
  loop: "{{ win_config.windows_files_to_copy }}"
  register: verify_copy

# ============================================
# PASO 4: DETERMINAR Y EJECUTAR SCRIPT SEGUN GRUPO
# ============================================
- name: "Windows | Determinar script a ejecutar segun el grupo"
  ansible.builtin.set_fact:
    script_a_ejecutar: >-
      {% if 'PROD' in group_names %}
      {{ win_config.windows_dest_path }}Instalar_Nagios_KIO.BAT
      {% elif 'DRP' in group_names %}
      {{ win_config.windows_dest_path }}Instalar_Nagios_TRIARA.BAT
      {% else %}
      ""
      {% endif %}
    ambiente_detectado: "{{ 'PROD' if 'PROD' in group_names else 'DRP' if 'DRP' in group_names else 'DESCONOCIDO' }}"

- name: "Windows | Mostrar informacion de ejecucion"
  ansible.builtin.debug:
    msg:
      - "Ambiente detectado: {{ ambiente_detectado }}"
      - "Script a ejecutar: {{ script_a_ejecutar }}"
      - "Ruta de trabajo: {{ win_config.windows_dest_path }}"

- name: "Windows | Ejecutar script de instalacion (como administrador)"
  ansible.windows.win_command: "{{ script_a_ejecutar }}"
  args:
    chdir: "{{ win_config.windows_dest_path }}"
  register: script_execution
  failed_when: false
  changed_when: script_execution.rc == 0
  when: script_a_ejecutar != ""
  become: true
  become_method: runas
  become_user: SYSTEM

- name: "Windows | Mostrar resultado de la ejecucion"
  ansible.builtin.debug:
    msg:
      - "Codigo de salida: {{ script_execution.rc }}"
      - "Output: {{ script_execution.stdout }}"
      - "Error: {{ script_execution.stderr }}"
  when: script_execution is defined

# ============================================
# PASO 5: VERIFICAR INSTALACION Y SERVICIO
# ============================================
- name: "Windows | Verificar si NCPA esta instalado"
  ansible.windows.win_stat:
    path: "C:\\Program Files\\Nagios\\NCPA\\ncpa.exe"
  register: ncpa_installed

- name: "Windows | Obtener version de NCPA"
  ansible.windows.win_shell: |
    if (Test-Path "C:\Program Files\Nagios\NCPA\ncpa.exe") {
        (Get-Item "C:\Program Files\Nagios\NCPA\ncpa.exe").VersionInfo.ProductVersion
    } else {
        Write-Output "No instalado"
    }
  register: ncpa_version
  when: ncpa_installed.stat.exists

- name: "Windows | Verificar estado del servicio NCPA"
  ansible.windows.win_shell: |
    $service = Get-Service -Name ncpasvc -ErrorAction SilentlyContinue
    if ($service) {
        $service.Status.ToString()
    } else {
        Write-Output "Servicio no encontrado"
    }
  register: service_status

- name: "Windows | Verificar puerto 5693"
  ansible.windows.win_shell: |
    $portTest = Test-NetConnection -ComputerName localhost -Port 5693 -WarningAction SilentlyContinue
    if ($portTest.TcpTestSucceeded) {
        Write-Output "Abierto"
    } else {
        Write-Output "Cerrado"
    }
  register: port_check
  when: service_status.stdout == "Running"

- name: "Windows | Mostrar diagnostico de instalacion"
  ansible.builtin.debug:
    msg:
      - "DIAGNOSTICO DE INSTALACION:"
      - "NCPA instalado: {{ 'Si' if ncpa_installed.stat.exists else 'No' }}"
      - "Version: {{ ncpa_version.stdout | default('N/A') }}"

# ============================================
# PASO 6: LIMPIAR ARCHIVOS TEMPORALES
# ============================================
- name: "Windows | Listar archivos en C: \ sys \ antes de limpiar"
  ansible.windows.win_shell: |
    Write-Output "Archivos en {{ win_config.windows_dest_path }}:"
    Get-ChildItem "{{ win_config.windows_dest_path }}" | Select-Object Name, Length | Format-Table -AutoSize
  register: files_before_cleanup

- name: "Windows | Mostrar archivos a eliminar"
  ansible.builtin.debug:
    msg: "{{ files_before_cleanup.stdout_lines }}"

- name: "Windows | Eliminar archivos copiados del directorio temporal"
  ansible.windows.win_file:
    path: "{{ win_config.windows_dest_path }}{{ item }}"
    state: absent
  loop: "{{ win_config.windows_files_to_copy }}"
  register: cleanup_result

- name: "Windows | Verificar que los archivos fueron eliminados"
  ansible.windows.win_stat:
    path: "{{ win_config.windows_dest_path }}{{ item }}"
  loop: "{{ win_config.windows_files_to_copy }}"
  register: verify_cleanup

- name: "Windows | Mostrar resultado de la limpieza"
  ansible.builtin.debug:
    msg: "ðŸ§¹ Archivo {{ item.item }} - {{ 'Eliminado' if not item.stat.exists else 'Aun existe' }}"
  loop: "{{ verify_cleanup.results }}"

# ============================================
# PASO 7: CONSOLIDAR RESULTADOS (MEJORADO)
# ============================================
- name: "Windows | Construir resultado de instalacion"
  ansible.builtin.set_fact:
    host_installation_results: "{{ host_installation_results + [ pkg_result ] }}"
  vars:
    pkg_result:
      package_name: "NCPA Agent"
      ambiente: "{{ ambiente_detectado }}"
      script_ejecutado: "{{ script_a_ejecutar | basename }}"
      status: "{{ 'success' if script_execution.rc == 0 and ncpa_installed.stat.exists else 'failed' }}"
      install_date: "{{ ansible_date_time.iso8601 }}"
      # CAMPOS DE VERIFICACION
      version_installed: "{{ ncpa_version.stdout | default('N/A') | trim }}"
      service_status: "{{ service_status.stdout | default('No instalado') | trim }}"
      port_status: "{{ port_check.stdout | default('N/A') }}"
      instalado: "{{ 'Si' if ncpa_installed.stat.exists else 'No' }}"
      install_path: "C:\\Program Files\\Nagios\\NCPA"
      # CAMPOS DE LIMPIEZA (NUEVO)
      cleanup_performed: "{{ 'Si' if cleanup_result is defined else 'No' }}"
      files_cleaned: "{{ win_config.windows_files_to_copy | join(', ') }}"
      # Informacion de ejecucion
      rc: "{{ script_execution.rc | default('') }}"
      script_output: "{{ script_execution.stdout | default('') }}"
      script_error: "{{ script_execution.stderr | default('') }}"
      files_copied: "{{ win_config.windows_files_to_copy | join(', ') }}"
      message: "Ejecutado script {{ script_a_ejecutar | basename }} en ambiente {{ ambiente_detectado }}. Limpieza completada."

- name: "Windows | Determinar estado general del host"
  ansible.builtin.set_fact:
    overall_host_status: >-
      {% set failed_states = host_installation_results | selectattr('status', 'equalto', 'failed') | list %}
      {% if failed_states | length > 0 %}failed
      {% else %}success
      {% endif %}

- name: "Windows | Construir resultado final para el host"
  ansible.builtin.set_fact:
    software_installation_result:
      host: "{{ inventory_hostname }}"
      os_family: "Windows"
      overall_status: "{{ overall_host_status }}"
      ambiente: "{{ ambiente_detectado }}"
      packages: "{{ host_installation_results }}"
      message: "Ejecutado script {{ script_a_ejecutar | basename }} en ambiente {{ ambiente_detectado }}. Archivos temporales eliminados."