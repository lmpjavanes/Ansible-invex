---
# roles/software_installer/tasks/render_reports.yml

- name: "Validar que report_dir esté definido"
  ansible.builtin.assert:
    that:
      - report_dir is defined
      - (report_dir | string | length) > 0
    fail_msg: "La variable 'report_dir' no está definida. Defínela en el play de control antes de renderizar."

- name: "Crear directorio del reporte en invd-ts-ansible (si no existe)"
  ansible.builtin.file:
    path: "{{ report_dir }}"
    state: directory
    mode: "0755"
  delegate_to: invd-ts-ansible
  run_once: true

- name: "Asegurar que las variables de resultados existen"
  ansible.builtin.set_fact:
    installation_results_linux: "{{ installation_results_linux | default([]) }}"
    installation_results_windows: "{{ installation_results_windows | default([]) }}"
  run_once: true

- name: "Debug - Mostrar estructura de datos (temporal)"
  ansible.builtin.debug:
    var: installation_results_linux
    verbosity: 1
  run_once: true

- name: "Reporte CSV (Linux) - VERIFICAR RUTA"
  ansible.builtin.template:
    src: "{{ role_path }}/templates/linux_installation_report.csv.j2"
    dest: "{{ report_dir }}/linux_installation_report.csv"
    mode: "0644"
  delegate_to: invd-ts-ansible
  run_once: true
  vars:
    ansible_remote_tmp: /tmp/.ansible

- name: "Reporte HTML (Linux) - VERIFICAR RUTA"
  ansible.builtin.template:
    src: "{{ role_path }}/templates/linux_installation_report.html.j2"
    dest: "{{ report_dir }}/linux_installation_report.html"
    mode: "0644"
  delegate_to: invd-ts-ansible
  run_once: true
  vars:
    ansible_remote_tmp: /tmp/.ansible

- name: "Reporte CSV (Windows)"
  ansible.builtin.template:
    src: "{{ role_path }}/templates/windows_installation_report.csv.j2"
    dest: "{{ report_dir }}/windows_installation_report.csv"
    mode: "0644"
  delegate_to: invd-ts-ansible
  run_once: true
  vars:
    ansible_remote_tmp: /tmp/.ansible

- name: "Reporte HTML (Windows)"
  ansible.builtin.template:
    src: "{{ role_path }}/templates/windows_installation_report.html.j2"
    dest: "{{ report_dir }}/windows_installation_report.html"
    mode: "0644"
  delegate_to: invd-ts-ansible
  run_once: true
  vars:
    ansible_remote_tmp: /tmp/.ansible

- name: "Mostrar rutas de los reportes generados"
  ansible.builtin.debug:
    msg:
      - "Reportes generados en: {{ report_dir }}"
      - "Linux CSV : {{ report_dir }}/linux_installation_report.csv"
      - "Linux HTML: {{ report_dir }}/linux_installation_report.html"
      - "Windows CSV : {{ report_dir }}/windows_installation_report.csv"
      - "Windows HTML: {{ report_dir }}/windows_installation_report.html"
  run_once: true

- name: "Verificar contenido del primer reporte"
  ansible.builtin.shell: "head -5 {{ report_dir }}/linux_installation_report.csv"
  delegate_to: invd-ts-ansible
  run_once: true
  register: report_check
  ignore_errors: true

- name: "Debug - Mostrar primeras líneas del reporte"
  ansible.builtin.debug:
    msg: "{{ report_check.stdout_lines }}"
  when: report_check is defined and report_check.stdout_lines is defined
  run_once: true