---
# Comandos "best effort" para campos que no siempre vienen en facts.
# Nota: el play para Linux corre con become: yes.

# Hipervisor (fino): systemd-detect-virt cuando esta disponible.
hypervisor_detect_cmd: |
  if command -v systemd-detect-virt >/dev/null 2>&1; then
    systemd-detect-virt 2>/dev/null || echo ""
  else
    echo ""
  fi

# Disco total en bytes
disk_total_bytes_cmd: "lsblk -b -dn -o SIZE 2>/dev/null | awk '{s+=$1} END{print s+0}'"

# Velocidad de NIC: ethtool -> sysfs speed
nic_speed_cmd: |
  IFACE="{{ ansible_default_ipv4.interface | default('') }}"
  if [ -z "$IFACE" ]; then echo ""; exit 0; fi
  if command -v ethtool >/dev/null 2>&1; then
    ethtool "$IFACE" 2>/dev/null | awk -F': ' '/Speed:/{print $2; exit}'
    exit 0
  fi
  if [ -r "/sys/class/net/$IFACE/speed" ]; then
    cat "/sys/class/net/$IFACE/speed" 2>/dev/null | awk '{print $1 "Mb/s"}'
    exit 0
  fi
  echo ""

# VLAN: subinterfaz -> ip -d link -> bridge vlan show
vlan_id_cmd: |
  IFACE="{{ ansible_default_ipv4.interface | default('') }}"
  if [ -z "$IFACE" ]; then echo ""; exit 0; fi

  if echo "$IFACE" | grep -q '\.'; then
    echo "$IFACE" | awk -F'.' '{print $2}'
    exit 0
  fi

  if command -v ip >/dev/null 2>&1; then
    VID=$(ip -d link show dev "$IFACE" 2>/dev/null | awk '/vlan id/{for(i=1;i<=NF;i++) if($i=="id"){print $(i+1); exit}}')
    if [ -n "$VID" ]; then echo "$VID"; exit 0; fi
  fi

  if command -v bridge >/dev/null 2>&1; then
    VID=$(bridge vlan show dev "$IFACE" 2>/dev/null | awk 'NR>1{print $1; exit}')
    if [ -n "$VID" ]; then echo "$VID"; exit 0; fi
  fi

  echo ""

# Fecha instalacion (best effort)
install_date_cmd: |
  if command -v rpm >/dev/null 2>&1; then
    rpm -q --qf '%{INSTALLTIME:date}\n' basesystem 2>/dev/null | head -1
  elif command -v dpkg-query >/dev/null 2>&1; then
    stat -c '%y' /var/log/installer 2>/dev/null | cut -d'.' -f1 || echo ""
  else
    stat -c '%y' / 2>/dev/null | cut -d'.' -f1 || echo ""
  fi

# =========================
# Detección de servicios por "ps" (extensible)
# =========================
# Agrega nuevos elementos a esta lista para detectar más procesos/servicios.
# Nota: se normaliza la salida para reportes; evita comandos interactivos.
ps_service_checks:
  - name: "Jboss"
    cmd: "ps -ef | grep -i jboss | grep -v grep"
  - name: "Java (sin Jboss)"
    cmd: "ps -ef | grep -i java | grep -v jboss | grep -v grep"
  - name: "Docker"
    cmd: "ps -ef | grep -i dockerd | grep -v grep"
  - name: "Base de Datos"
    cmd: "ps -ef | egrep -i 'pmon|postgres -D' | grep -v grep"
