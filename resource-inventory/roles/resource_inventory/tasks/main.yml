---
- name: Definir os_family seguro
  ansible.builtin.set_fact:
    os_family_safe: "{{ ansible_os_family | default('unknown') }}"

- name: Detectar host no disponibles
  ansible.builtin.set_fact:
    host_unavailable: "{{ os_family_safe == 'unknown' }}"

- name: Marcar resultado como servidor no disponible
  ansible.builtin.set_fact:
    resource_inventory_asset:
      host: "{{ inventory_hostname }}"
      os_family: "{{ os_family_safe }}"
      checked_at: "{{ ansible_date_time.iso8601 | default('') }}"
      status: "unavailable"
      message: "Servidor no disponible"
  when: host_unavailable

- name: Terminar role en host no disponible
  ansible.builtin.meta: end_host
  when: host_unavailable

# =========================
# Linux (deteccion mas fina)
# =========================
- name: Linux | Cargar catalogo vars
  ansible.builtin.include_vars:
    file: "{{ role_path }}/vars/commands_linux.yml"
    name: cfg_linux
  when: os_family_safe != 'Windows'

- name: Linux | Detectar hipervisor
  ansible.builtin.shell: "{{ cfg_linux.hypervisor_detect_cmd }}"
  args:
    executable: /bin/bash
  register: linux_hv
  changed_when: false
  failed_when: false
  when: os_family_safe != 'Windows'

- name: Linux | Obtener disk bytes
  ansible.builtin.shell: "{{ cfg_linux.disk_total_bytes_cmd }}"
  args:
    executable: /bin/bash
  register: linux_disk_bytes
  changed_when: false
  failed_when: false
  when: os_family_safe != 'Windows'

- name: Linux | Obtener velocidad de red
  ansible.builtin.shell: "{{ cfg_linux.nic_speed_cmd }}"
  args:
    executable: /bin/bash
  register: linux_nic_speed
  changed_when: false
  failed_when: false
  when: os_family_safe != 'Windows'

- name: Linux | Obtener VLAN
  ansible.builtin.shell: "{{ cfg_linux.vlan_id_cmd }}"
  args:
    executable: /bin/bash
  register: linux_vlan
  changed_when: false
  failed_when: false
  when: os_family_safe != 'Windows'

- name: Linux | Obtener fecha de instalacion
  ansible.builtin.shell: "{{ cfg_linux.install_date_cmd }}"
  args:
    executable: /bin/bash
  register: linux_install_date
  changed_when: false
  failed_when: false
  when: os_family_safe != 'Windows'

- name: Linux | Ejecutar detecciÃ³n de servicios por ps (extensible)
  ansible.builtin.shell: "{{ item.cmd }}"
  args:
    executable: /bin/bash
  register: linux_ps_checks
  loop: "{{ cfg_linux.ps_service_checks | default([]) }}"
  loop_control:
    label: "{{ item.name }}"
  changed_when: false
  failed_when: false
  when: os_family_safe != 'Windows'

- name: Linux | Construir lista de servicios detectados
  ansible.builtin.set_fact:
    linux_ps_hits: >-
      {%- set hits = [] -%}
      {%- for r in (linux_ps_checks.results | default([])) -%}
        {%- set out = (r.stdout | default('') | string | trim) -%}
        {%- if out != '' -%}
          {%- set _ = hits.append({'service': r.item.name, 'result': out}) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ hits }}
  when: os_family_safe != 'Windows'

- name: Linux | Normalizar columnas para reportes (Servicio / Resultado ps)
  ansible.builtin.set_fact:
    linux_service_ps: "{{ (linux_ps_hits | default([]) | map(attribute='service') | list) | join(' | ') }}"
    linux_result_ps: >-
      {{
        (linux_ps_hits | default([]) | map(attribute='result') | list)
        | map('regex_replace', '[\r\n]+', ' ')
        | join(' || ')
      }}
  when: os_family_safe != 'Windows'

- name: Linux | Normalizar hipervisor a nombres comunes
  ansible.builtin.set_fact:
    linux_hypervisor_fine: >-
      {%- set hv = (linux_hv.stdout | default('') | string | trim | lower) -%}
      {%- if hv in ['kvm','qemu'] -%}KVM/QEMU
      {%- elif hv == 'vmware' -%}VMware
      {%- elif hv in ['microsoft','hyperv'] -%}Hyper-V
      {%- elif hv == 'xen' -%}Xen
      {%- elif hv in ['oracle','vbox','virtualbox'] -%}VirtualBox
      {%- elif hv == 'none' or hv == '' -%}{{ ansible_facts.virtualization_type | default('') }}
      {%- else -%}{{ hv }}
      {%- endif -%}
  when: os_family_safe != 'Windows'

- name: Linux | Construir asset inventory
  ansible.builtin.set_fact:
    resource_inventory_asset:
      host: "{{ inventory_hostname }}"
      os_family: "Linux"
      checked_at: "{{ ansible_date_time.iso8601 }}"
      status: "ok"
      message: ""
      server_name: "{{ ansible_facts.hostname | default(inventory_hostname) }}"
      server_type: >-
        {{ 'Virtual' if (ansible_facts.virtualization_role | default('') == 'guest') else 'Fisico' }}
      server_state: "Reachable"
      brand: "{{ ansible_facts.system_vendor | default('') }}"
      model: "{{ ansible_facts.product_name | default('') }}"
      serial_number: "{{ ansible_facts.product_serial | default('') }}"
      processor_type: "CPU"
      processor_count: "{{ ansible_facts.processor_count | default('') }}"
      processor_model: "{{ ansible_facts.processor[-1] | default(ansible_facts.processor[0] | default('')) }}"
      ram_mb: "{{ ansible_facts.memtotal_mb | default('') }}"
      disk_gb: >-
        {{ ((linux_disk_bytes.stdout | default('0') | int) / 1073741824) | round(2) }}
      network_speed: "{{ (linux_nic_speed.stdout | default('') | string | trim) }}"
      hypervisor_type: "{{ linux_hypervisor_fine | default(ansible_facts.virtualization_type | default('')) }}"
      os_type: "{{ ansible_facts.distribution | default('Linux') }}"
      os_version: "{{ ansible_facts.distribution_version | default('') }}"
      os_arch: "{{ ansible_facts.architecture | default('') }}"
      install_date: "{{ (linux_install_date.stdout | default('') | string | trim) }}"
      ip_assigned: "{{ ansible_facts.default_ipv4.address | default('') }}"
      mac_assigned: "{{ ansible_facts.default_ipv4.macaddress | default('') }}"
      vlan_assigned: "{{ (linux_vlan.stdout | default('') | string | trim) }}"
      service_ps: "{{ linux_service_ps | default('') }}"
      result_ps: "{{ linux_result_ps | default('') }}"
  when: os_family_safe != 'Windows'

# =========================
# Windows (deteccion mas fina)
# =========================
- name: Windows | Obtener inventario
  ansible.windows.win_powershell:
    script: |
      $ErrorActionPreference = "SilentlyContinue"

      $cs   = Get-CimInstance Win32_ComputerSystem
      $bios = Get-CimInstance Win32_BIOS
      $os   = Get-CimInstance Win32_OperatingSystem
      $cpu  = Get-CimInstance Win32_Processor

      # Disco total
      $disks = Get-CimInstance Win32_LogicalDisk -Filter "DriveType=3"
      $diskSize = 0
      foreach ($d in $disks) { $diskSize += [int64]$d.Size }

      # NIC por default route
      $route = Get-NetRoute -DestinationPrefix "0.0.0.0/0" | Sort-Object RouteMetric | Select-Object -First 1
      $nic = $null
      if ($route) {
        $nic = Get-NetAdapter -InterfaceIndex $route.IfIndex -ErrorAction SilentlyContinue
      }
      if (-not $nic) {
        $nic = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Sort-Object InterfaceMetric | Select-Object -First 1
      }

      $ip = ""
      $mac = ""
      $link = ""
      $vlan = ""
      if ($nic) {
        $mac = $nic.MacAddress
        $link = $nic.LinkSpeed

        $ipObj = Get-NetIPAddress -AddressFamily IPv4 -InterfaceIndex $nic.IfIndex |
                Where-Object {$_.IPAddress -notlike "169.254*"} | Select-Object -First 1
        if ($ipObj) { $ip = $ipObj.IPAddress }

        # VLAN: NetAdapterVlan -> AdvancedProperty
        try {
          $v = Get-NetAdapterVlan -InterfaceAlias $nic.Name -ErrorAction Stop
          if ($v -and $v.VlanID -ne $null) { $vlan = [string]$v.VlanID }
        } catch {}
        if (-not $vlan) {
          try {
            $adv = Get-NetAdapterAdvancedProperty -Name $nic.Name |
                   Where-Object { $_.DisplayName -match "VLAN|Vlan|VLAN ID|Vlan ID" } |
                   Select-Object -First 1
            if ($adv) { $vlan = [string]$adv.DisplayValue }
          } catch {}
        }
      }

      # Hipervisor fino
      $m = ($cs.Manufacturer + " " + $cs.Model)
      $hypervisor = ""
      $isVirtual = $false

      if ($m -match "VMware") { $isVirtual = $true; $hypervisor = "VMware" }
      elseif ($m -match "Hyper-V|Virtual Machine" -and $cs.Manufacturer -match "Microsoft") { $isVirtual = $true; $hypervisor = "Hyper-V" }
      elseif ($m -match "KVM|QEMU") { $isVirtual = $true; $hypervisor = "KVM/QEMU" }
      elseif ($m -match "Xen") { $isVirtual = $true; $hypervisor = "Xen" }
      elseif ($m -match "VirtualBox") { $isVirtual = $true; $hypervisor = "VirtualBox" }
      elseif ($m -match "Amazon EC2") { $isVirtual = $true; $hypervisor = "AWS (Xen/Nitro)" }
      elseif ($cs.HypervisorPresent) { $isVirtual = $true; $hypervisor = "Hypervisor (detectado)" }

      $obj = [ordered]@{
        server_name       = $env:COMPUTERNAME
        server_type       = $(if ($isVirtual) { "Virtual" } else { "Fisico" })
        server_state      = "Reachable"
        brand             = $cs.Manufacturer
        model             = $cs.Model
        serial_number     = $bios.SerialNumber
        processor_type    = "CPU"
        processor_count   = ($cpu | Measure-Object).Count
        processor_model   = (($cpu | Select-Object -First 1).Name)
        ram_mb            = [math]::Round($cs.TotalPhysicalMemory / 1MB, 0)
        disk_gb           = [math]::Round($diskSize / 1GB, 2)
        network_speed     = "$link"
        hypervisor_type   = $hypervisor
        os_type           = $os.Caption
        os_version        = $os.Version
        os_arch           = $os.OSArchitecture
        install_date      = ($os.InstallDate)
        ip_assigned       = $ip
        mac_assigned      = $mac
        vlan_assigned     = "$vlan"
      }

      $obj | ConvertTo-Json -Compress
  register: win_asset_json
  changed_when: false
  failed_when: false
  when: os_family_safe == 'Windows'

- name: Windows | Normalizar salida JSON a string
  ansible.builtin.set_fact:
    win_asset_json_str: >-
      {% set o = win_asset_json.output | default([]) %}
      {% if o is string %}
      {{ o | trim }}
      {% else %}
      {{ (o | join('') | trim) }}
      {% endif %}
  when: os_family_safe == 'Windows'

- name: Windows | Extraer solo el JSON
  ansible.builtin.set_fact:
    win_asset_json_only: >-
      {% set matches = (win_asset_json_str | regex_findall('({.*})', multiline=False, ignorecase=False)) %}
      {{ (matches | length > 0) | ternary((matches | last), '{}') }}
  when: os_family_safe == 'Windows'

- name: Windows | Parsear JSON
  ansible.builtin.set_fact:
    win_asset: "{{ win_asset_json_only | from_json }}"
  when: os_family_safe == 'Windows'

- name: Windows | Construir asset inventory final
  ansible.builtin.set_fact:
    resource_inventory_asset:
      host: "{{ inventory_hostname }}"
      os_family: "Windows"
      checked_at: "{{ ansible_date_time.iso8601 }}"
      status: "ok"
      message: ""
      server_name: "{{ win_asset.server_name | default(inventory_hostname) }}"
      server_type: "{{ win_asset.server_type | default('') }}"
      server_state: "{{ win_asset.server_state | default('') }}"
      brand: "{{ win_asset.brand | default('') }}"
      model: "{{ win_asset.model | default('') }}"
      serial_number: "{{ win_asset.serial_number | default('') }}"
      processor_type: "{{ win_asset.processor_type | default('') }}"
      processor_count: "{{ win_asset.processor_count | default('') }}"
      processor_model: "{{ win_asset.processor_model | default('') }}"
      ram_mb: "{{ win_asset.ram_mb | default('') }}"
      disk_gb: "{{ win_asset.disk_gb | default('') }}"
      network_speed: "{{ win_asset.network_speed | default('') }}"
      hypervisor_type: "{{ win_asset.hypervisor_type | default('') }}"
      os_type: "{{ win_asset.os_type | default('Windows') }}"
      os_version: "{{ win_asset.os_version | default('') }}"
      os_arch: "{{ win_asset.os_arch | default('') }}"
      install_date: "{{ win_asset.install_date | default('') }}"
      ip_assigned: "{{ win_asset.ip_assigned | default('') }}"
      mac_assigned: "{{ win_asset.mac_assigned | default('') }}"
      vlan_assigned: "{{ win_asset.vlan_assigned | default('') }}"
  when: os_family_safe == 'Windows'
