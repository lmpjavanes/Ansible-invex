# Render de reportes usando templates del rol.
- name: Validar que report_dir esté definido
  ansible.builtin.assert:
    that:
      - report_dir is defined
      - (report_dir | string | length) > 0
    fail_msg: "La variable 'report_dir' no está definida. Defínela en el play de control antes de renderizar."

- name: Crear directorio del reporte en inv-ts-ansible (si no existe)
  ansible.builtin.file:
    path: "{{ report_dir }}"
    state: directory
    mode: "0755"
  delegate_to: inv-ts-ansible
  run_once: true

# Si baseline_linux_names no viene en el play de control, intentamos recuperarla desde el primer host Linux.
- name: Asegurar baseline_linux_names (si no viene en el play de control)
  ansible.builtin.set_fact:
    baseline_linux_names: >-
      {{
        baseline_linux_names
        | default(hostvars[(groups['LINUX'] | default([]) | first)].baseline_linux_names | default([]))
      }}
  run_once: true

# (Opcional) Si audit_linux/audit_windows no existen, inicializamos para no romper templates.
- name: Asegurar variables audit_* (evitar undefined)
  ansible.builtin.set_fact:
    audit_linux: "{{ audit_linux | default([]) }}"
    audit_windows: "{{ audit_windows | default([]) }}"
  run_once: true

# =========================
# Render Linux
# =========================
- name: Reporte CSV (Linux software)
  ansible.builtin.template:
    src: linux_software.csv.j2
    dest: "{{ report_dir }}/linux_software_inventory.csv"
    mode: "0644"
  delegate_to: inv-ts-ansible
  run_once: true

- name: Reporte HTML (Linux software)
  ansible.builtin.template:
    src: linux_software.html.j2
    dest: "{{ report_dir }}/linux_software_inventory.html"
    mode: "0644"
  delegate_to: inv-ts-ansible
  run_once: true

# =========================
# Render Windows
# =========================
- name: Reporte CSV (Windows software)
  ansible.builtin.template:
    src: windows_software.csv.j2
    dest: "{{ report_dir }}/windows_software_inventory.csv"
    mode: "0644"
  delegate_to: inv-ts-ansible
  run_once: true

- name: Reporte HTML (Windows software)
  ansible.builtin.template:
    src: windows_software.html.j2
    dest: "{{ report_dir }}/windows_software_inventory.html"
    mode: "0644"
  delegate_to: inv-ts-ansible
  run_once: true

- name: Mostrar rutas de salida
  ansible.builtin.debug:
    msg:
      - "Reportes generados en: {{ report_dir }}"
      - "Linux CSV : {{ report_dir }}/linux_software_inventory.csv"
      - "Linux HTML: {{ report_dir }}/linux_software_inventory.html"
      - "Windows CSV : {{ report_dir }}/windows_software_inventory.csv"
      - "Windows HTML: {{ report_dir }}/windows_software_inventory.html"
  run_once: true