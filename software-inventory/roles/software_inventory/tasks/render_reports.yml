# Render de reportes usando templates del rol.

- name: Validar que report_dir este definido
  ansible.builtin.assert:
    that:
      - report_dir is defined
      - (report_dir | string | length) > 0
    fail_msg: "La variable 'report_dir' no esta definida. Definela en el play de control antes de renderizar."

- name: Definir modo de generacion de reportes (safe)
  ansible.builtin.set_fact:
    report_generation_mode_safe: "{{ report_generation_mode | default('consolidated') | lower }}"
  run_once: true

- name: Validar report_generation_mode (solo soportamos consolidated en opcion 1)
  ansible.builtin.assert:
    that:
      - report_generation_mode_safe == 'consolidated'
    fail_msg: >-
      "Este render_reports.yml es solo para Opcion 1 (consolidated).
      Valor recibido: '{{ report_generation_mode_safe }}'"

- name: Crear directorio base del reporte en invd-ts-ansible (si no existe)
  ansible.builtin.file:
    path: "{{ report_dir }}"
    state: directory
    mode: "0755"
  delegate_to: invd-ts-ansible
  run_once: true

# Si baseline_linux_names no viene en el play de control, intentamos recuperarla desde el primer host Linux.
- name: Asegurar baseline_linux_names (si no viene en el play de control)
  ansible.builtin.set_fact:
    baseline_linux_names: >-
      {{
        baseline_linux_names
        | default(hostvars[(groups['LINUX'] | default([]) | first)].baseline_linux_names | default([]))
      }}
  run_once: true

# =========================
# Congelar listas consolidadas
# (aqui es donde tu proyecto ya construye audit_linux_all / audit_windows_all)
# =========================
- name: Inicializar audit_linux_all y audit_windows_all (si no existen)
  ansible.builtin.set_fact:
    audit_linux_all: "{{ audit_linux_all | default(audit_linux | default([])) }}"
    audit_windows_all: "{{ audit_windows_all | default(audit_windows | default([])) }}"
  run_once: true

# =========================
# DEBUG (para ver exactamente que se va a renderizar)
# =========================
- name: DEBUG tipos y ejemplo (audit_linux_all / audit_windows_all)
  ansible.builtin.debug:
    msg:
      - "audit_linux_all type={{ audit_linux_all | type_debug }}"
      - "audit_linux_all len={{ audit_linux_all | length }}"
      - "audit_linux_all first type={{ (audit_linux_all | first) | type_debug if (audit_linux_all | length) > 0 else 'N/A' }}"
      - "audit_linux_all first keys={{ (audit_linux_all | first).keys() | list if (audit_linux_all | length) > 0 and ((audit_linux_all | first) is mapping) else 'N/A' }}"
      - "audit_windows_all type={{ audit_windows_all | type_debug }}"
      - "audit_windows_all len={{ audit_windows_all | length }}"
      - "audit_windows_all first type={{ (audit_windows_all | first) | type_debug if (audit_windows_all | length) > 0 else 'N/A' }}"
      - "audit_windows_all first keys={{ (audit_windows_all | first).keys() | list if (audit_windows_all | length) > 0 and ((audit_windows_all | first) is mapping) else 'N/A' }}"
  run_once: true

# (Opcional) Asegurar que lo que viene sea lista de diccionarios con 'host'
- name: ASSERT audit_linux_all es lista de dict con host
  ansible.builtin.assert:
    that:
      - audit_linux_all is sequence
      - (audit_linux_all | length) == 0 or ((audit_linux_all | first) is mapping and (audit_linux_all | first).host is defined)
    fail_msg: "audit_linux_all no tiene la estructura esperada (lista de dicts con clave 'host')."
  run_once: true

- name: ASSERT audit_windows_all es lista de dict con host
  ansible.builtin.assert:
    that:
      - audit_windows_all is sequence
      - (audit_windows_all | length) == 0 or ((audit_windows_all | first) is mapping and (audit_windows_all | first).host is defined)
    fail_msg: "audit_windows_all no tiene la estructura esperada (lista de dicts con clave 'host')."
  run_once: true

# =========================
# Reportes CONSOLIDADOS (tal como estaban)
# =========================
- name: Reporte CSV (Linux software) - Consolidado
  ansible.builtin.template:
    src: linux_software.csv.j2
    dest: "{{ report_dir }}/linux_software_inventory.csv"
    mode: "0644"
  delegate_to: invd-ts-ansible
  run_once: true

- name: Reporte HTML (Linux software) - Consolidado
  ansible.builtin.template:
    src: linux_software.html.j2
    dest: "{{ report_dir }}/linux_software_inventory.html"
    mode: "0644"
  delegate_to: invd-ts-ansible
  run_once: true

- name: Reporte CSV (Windows software) - Consolidado
  ansible.builtin.template:
    src: windows_software.csv.j2
    dest: "{{ report_dir }}/windows_software_inventory.csv"
    mode: "0644"
  delegate_to: invd-ts-ansible
  run_once: true

- name: Reporte HTML (Windows software) - Consolidado
  ansible.builtin.template:
    src: windows_software.html.j2
    dest: "{{ report_dir }}/windows_software_inventory.html"
    mode: "0644"
  delegate_to: invd-ts-ansible
  run_once: true

- name: Mostrar rutas de salida
  ansible.builtin.debug:
    msg:
      - "Modo: {{ report_generation_mode_safe }}"
      - "Directorio base: {{ report_dir }}"
      - "Consolidados: {{ report_dir }}"
  run_once: true
