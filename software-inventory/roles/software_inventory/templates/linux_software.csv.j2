host,checked_at,status,paquete_valido,package_nevra,install_date,summary
{#
  Selección "a prueba de balas":
  - Usar audit_linux_single SOLO si:
    * está definida
    * es una secuencia (lista)
    * NO es string
    * tiene al menos 1 elemento
    * el primer elemento es dict (mapping)
    * y tiene clave/atributo host
  - Si no cumple, usar audit_linux_all (consolidado)
#}
{% set _audit_linux =
  (
    audit_linux_single
    if (
      audit_linux_single is defined
      and (audit_linux_single is sequence)
      and (audit_linux_single is not string)
      and (audit_linux_single | length > 0)
      and ((audit_linux_single | first) is mapping)
      and ((audit_linux_single | first).host is defined)
    )
    else (audit_linux_all | default([]))
  )
%}

{% for hostres in _audit_linux %}
{% if hostres.status | default('ok') == 'unavailable' %}
{{ hostres.host | default('') }},{{ hostres.checked_at | default('') }},unavailable,,,,
{% else %}
{% for pkg in (hostres.packages | default([])) %}
{% set nevra = (pkg.package_full | default('') | string | trim) %}
{% set pkg_name = (pkg.name | default('') | string | trim | lower) %}
{{ hostres.host | default('') }},{{ hostres.checked_at | default('') }},ok,"{{ '*' if pkg_name in (baseline_linux_names | default([])) else '' }}",{{ (nevra | regex_replace('[\r\n]+',' ') | replace('"','""')) }},{{ (pkg.install_date | default('') | string | trim | regex_replace('[\r\n]+',' ') | replace('"','""')) }},"{{ (pkg.summary | default('') | string | trim | regex_replace('[\r\n]+',' ') | replace('"','""')) }}"
{% endfor %}
{% endif %}
{% endfor %}
