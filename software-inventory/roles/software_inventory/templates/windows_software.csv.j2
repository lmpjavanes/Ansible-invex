DisplayName,DisplayVersion,Publisher,InstallDate,Host,CheckedAt,Status,Message
{#
  Selección "a prueba de balas":
  - Usar audit_windows_single SOLO si:
    * está definida
    * es una secuencia (lista)
    * NO es string
    * tiene al menos 1 elemento
    * el primer elemento es dict (mapping)
    * y tiene clave/atributo host
  - Si no cumple, usar audit_windows_all (consolidado)
#}
{% set _audit_windows =
  (
    audit_windows_single
    if (
      audit_windows_single is defined
      and (audit_windows_single is sequence)
      and (audit_windows_single is not string)
      and (audit_windows_single | length > 0)
      and ((audit_windows_single | first) is mapping)
      and ((audit_windows_single | first).host is defined)
    )
    else (audit_windows_all | default([]))
  )
%}

{% for hostres in _audit_windows -%}
{% if hostres.status | default('ok') == 'unavailable' -%}
,,,,{{ hostres.host | default('') }},{{ hostres.checked_at | default('') }},{{ hostres.status | default('unavailable') }},{{ hostres.message | default('') }}
{% else -%}
{% for pkg in hostres.packages | default([]) -%}
{{ pkg.DisplayName | default('') }},{{ pkg.DisplayVersion | default('') }},{{ pkg.Publisher | default('') }},{{ pkg.InstallDate | default('') }},{{ hostres.host | default('') }},{{ hostres.checked_at | default('') }},ok,
{% endfor -%}
{% endif -%}
{% endfor -%}